.deployScriptSecrets: &deployScriptSecrets
  - wget https://raw.githubusercontent.com/AckeeDevOps/gitlabci-templates/master/scripts/helm_deploy.sh -O /usr/local/bin/helm-deploy
  - chmod +x /usr/local/bin/helm-deploy
  - gke-init
  - vaultier
  - helm-deploy
    
.deployBranchMasterSecrets:
  image: ackee/helmer-gke:v0.0.9
  stage: deploy
# variables have to be specified in the certain job!
#  variables:
#    GCLOUD_PROJECT_ID:
#    GCLOUD_GKE_CLUSTER_NAME:
#    GCLOUD_GKE_ZONE:
#    # Vaultier settings
#    PLUGIN_RUN_CAUSE: delivery
#    PLUGIN_OUTPUT_FORMAT: helm
#    PLUGIN_SECRET_OUTPUT_PATH: /tmp/secrets.json
#    # Helm values file
#    HELM_BASE_VALUES: helm/values/production.yaml 
  script: *deployScriptSecrets
  only:
    refs: ["master"]
    variables:
      - $CI_PIPELINE_SOURCE == "push"
  environment:
    name: production
  when: manual
    
.deployBranchDevelopmentSecrets:
  image: ackee/helmer-gke:v0.0.9
  stage: deploy
# variables have to be specified in the certain job!
#  variables:
#    GCLOUD_PROJECT_ID:
#    GCLOUD_GKE_CLUSTER_NAME:
#    GCLOUD_GKE_ZONE:
#    # Vaultier settings
#    PLUGIN_RUN_CAUSE: delivery
#    PLUGIN_OUTPUT_FORMAT: helm
#    PLUGIN_SECRET_OUTPUT_PATH: /tmp/secrets.json
#    # Helm values file
#    HELM_BASE_VALUES: helm/values/production.yaml 
  script: *deployScriptSecrets
  only:
    refs: ["development"]
    variables:
      - $CI_PIPELINE_SOURCE == "push"
  environment:
    name: development
