.deployScriptSecrets: &deployScriptSecrets
  - wget https://raw.githubusercontent.com/AckeeDevOps/gitlabci-templates/master/scripts/helm_deploy.sh -O /usr/local/bin/helm-deploy
  - chmod +x /usr/local/bin/helm-deploy
  - gke-init
  - vaultier
  - helm-deploy
  
# .deployBranchMasterSecrets and .deployBranchDevelopmentSecrets
# have to be always configured with followin variables:
# GCP/GKE specific variables:
#   GCLOUD_PROJECT_ID:
#   GCLOUD_GKE_CLUSTER_NAME:
#   GCLOUD_GKE_ZONE:
# Vaultier specific variables:
#   PLUGIN_VAULT_ADDR:
#   PLUGIN_VAULT_TOKEN:
#   PLUGIN_BRANCH:
#   PLUGIN_SECRET_SPECS_PATH
#   PLUGIN_RUN_CAUSE: (test or delivery)
#   PLUGIN_OUTPUT_FORMAT: (helm or dotenv)
#   PLUGIN_SECRET_OUTPUT_PATH
    
.deployBranchMasterSecrets:
  image: ackee/helmer-gke:v0.0.9
  stage: deploy
  script: *deployScriptSecrets
  only:
    refs: ["master"]
    variables:
      - $CI_PIPELINE_SOURCE == "push"
  environment:
    name: production
  when: manual
    
.deployBranchDevelopmentSecrets:
  image: ackee/helmer-gke:v0.0.9
  stage: deploy
  script: *deployScriptSecrets
  only:
    refs: ["development"]
    variables:
      - $CI_PIPELINE_SOURCE == "push"
  environment:
    name: development
