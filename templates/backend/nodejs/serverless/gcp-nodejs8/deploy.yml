.initSSH: &initSSH |
  echo "Initializing SSH/GIT ..."
  mkdir ~/.ssh/
  echo ${SSH_KEY} | base64 -d > ~/.ssh/id_rsa
  chmod 0400 ~/.ssh/id_rsa
  eval `ssh-agent -s` && ssh-add ~/.ssh/id_rsa
  
.initNPM: &initNPM |
  echo "Initializing NPM ..."
  npm set unsafe-perm true
  npm set progress=false
  npm set loglevel=error
  npm install -g serverless
  export JOBS=max

.beforeScriptDeploySecretsDevelopment: &preDeploySecretsDevelopment
  #  Validate variables
  - echo validation TBD
  # /Validate variables
  #  Prepare ssh/git
  - *initSSH
  # /Prepare ssh/git
  #  Prepare Google auth
  - echo "${GCLOUD_SA_KEY_DEVELOPMENT}" | base64 -d > /tmp/key.json
  - export GOOGLE_APPLICATION_CREDENTIALS=/tmp/key.json
  # /Prepare Google auth
  #  Configure NPM
  - *initNPM
  # /Configure NPM
  
.beforeScriptDeploySecretsStage: &preDeploySecretsStage
  #  Validate variables
  - echo validation TBD
  # /Validate variables
  #  Prepare ssh/git
  - *initSSH
  # /Prepare ssh/git
  #  Prepare Google auth
  - echo "${GCLOUD_SA_KEY_STAGE}" | base64 -d > /tmp/key.json
  - export GOOGLE_APPLICATION_CREDENTIALS=/tmp/key.json
  # /Prepare Google auth
  #  Configure NPM
  - *initNPM
  # /Configure NPM
  
.beforeScriptDeploySecretsMaster: &preDeploySecretsMaster
  #  Validate variables
  - echo validation TBD
  # /Validate variables
  #  Prepare ssh/git
  - *initSSH
  # /Prepare ssh/git
  #  Prepare Google auth
  - echo "${GCLOUD_SA_KEY_PRODUCTION}" | base64 -d > /tmp/key.json
  - export GOOGLE_APPLICATION_CREDENTIALS=/tmp/key.json
  # /Prepare Google auth
  #  Configure NPM
  - *initNPM
  # /Configure NPM
  
.deployBranchSecrets:
  image: node:8
  stage: deploy
  allow_failure: false
  variables:
  
.deployBranchSecretsDevelopment:
  extends: .deployBranchSecrets
  before_script: *preDeploySecretsDevelopment
  script:
    - npm i
    - serverless deploy --stage=development --gcpProject="${GCLOUD_PROJECT_ID_DEVELOPMENT}"
  only:
    refs: ["development"]
    variables:
      - $CI_PIPELINE_SOURCE == "push"
  environment:
    name: development
    
.deployBranchSecretsStage:
  extends: .deployBranchSecrets
  before_script: *preDeploySecretsStage
  script:
    - npm i
    - serverless deploy --stage=stage --gcpProject="${GCLOUD_PROJECT_ID_STAGE}"
  only:
    refs: ["stage"]
    variables:
      - $CI_PIPELINE_SOURCE == "push"
  environment:
    name: stage
    
.deployBranchSecretsMaster:
  extends: .deployBranchSecrets
  before_script: *preDeploySecretsMaster
  script:
    - npm i
    - serverless deploy --stage=production --gcpProject="${GCLOUD_PROJECT_ID_PRODUCTION}"
  only:
    refs: ["master"]
    variables:
      - $CI_PIPELINE_SOURCE == "push"
  environment:
    name: production
