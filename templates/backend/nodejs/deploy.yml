# .deployBranchMasterSecrets and .deployBranchDevelopmentSecrets
# have to be always configured with followin variables:
# GCP/GKE specific variables:
#   GCLOUD_PROJECT_ID:
#   GCLOUD_GKE_CLUSTER_NAME:
#   GCLOUD_GKE_ZONE:
#   GCLOUD_GKE_NAMESPACE:
# Vaultier specific variables:
#   VAULTIER_VAULT_ADDR:
#   VAULTIER_VAULT_TOKEN:
#   VAULTIER_BRANCH:
#   VAULTIER_SECRET_SPECS_PATH
#   VAULTIER_RUN_CAUSE: (test or delivery)
#   VAULTIER_OUTPUT_FORMAT: (helm or dotenv)
#   VAULTIER_SECRET_OUTPUT_PATH

# if you don't want to specify variables in the yob,
# you can specify following variables at the top of your .gitlab-ci.yml:
# Production:
#   GCLOUD_PROJECT_ID_PRODUCTION
#   GCLOUD_GKE_CLUSTER_PRODUCTION
#   GCLOUD_GKE_ZONE_PRODUCTION
#   GCLOUD_GKE_NAMESPACE_PRODUCTION
# Development:
#   GCLOUD_PROJECT_ID_DEVELOPMENT
#   GCLOUD_GKE_CLUSTER_DEVELOPMENT
#   GCLOUD_GKE_ZONE_DEVELOPMENT
#   GCLOUD_GKE_NAMESPACE_DEVELOPMENT
# Stage:
#   GCLOUD_PROJECT_ID_STAGE
#   GCLOUD_GKE_CLUSTER_STAGE
#   GCLOUD_GKE_ZONE_STAGE
#   GCLOUD_GKE_NAMESPACE_STAGE

.deployScriptSecrets: &deployScriptSecrets
  - wget https://raw.githubusercontent.com/AckeeDevOps/gitlabci-templates/master/scripts/helm_deploy_secrets.sh -O /usr/local/bin/helm-deploy
  - chmod +x /usr/local/bin/helm-deploy
  - gke-init
  - vaultier
  - helm-deploy
    
.deployBranchMasterSecrets:
  image: ${HELMER_IMAGE}
  stage: deploy
  variables:
    GCLOUD_PROJECT_ID: ${GCLOUD_PROJECT_ID_PRODUCTION}
    GCLOUD_GKE_CLUSTER_NAME: ${GCLOUD_GKE_CLUSTER_PRODUCTION}
    GCLOUD_GKE_ZONE: ${GCLOUD_GKE_ZONE_PRODUCTION}
    GCLOUD_GKE_NAMESPACE: ${GCLOUD_GKE_NAMESPACE_PRODUCTION}
    VAULTIER_RUN_CAUSE: delivery
    VAULTIER_OUTPUT_FORMAT: helm
    VAULTIER_SECRET_OUTPUT_PATH: /tmp/secrets.json
  script: *deployScriptSecrets
  allow_failure: false # important for manual jobs
  only:
    refs: ["master"]
    variables:
      - $CI_PIPELINE_SOURCE == "push"
  environment:
    name: production
  when: manual
    
.deployBranchDevelopmentSecrets:
  image: ${HELMER_IMAGE}
  stage: deploy
  variables:
    GCLOUD_PROJECT_ID: ${GCLOUD_PROJECT_ID_DEVELOPMENT}
    GCLOUD_GKE_CLUSTER_NAME: ${GCLOUD_GKE_CLUSTER_DEVELOPMENT}
    GCLOUD_GKE_ZONE: ${GCLOUD_GKE_ZONE_DEVELOPMENT}
    GCLOUD_GKE_NAMESPACE: ${GCLOUD_GKE_NAMESPACE_DEVELOPMENT}
    VAULTIER_RUN_CAUSE: delivery
    VAULTIER_OUTPUT_FORMAT: helm
    VAULTIER_SECRET_OUTPUT_PATH: /tmp/secrets.json
  script: *deployScriptSecrets
  allow_failure: false # important for manual jobs
  only:
    refs: ["development"]
    variables:
      - $CI_PIPELINE_SOURCE == "push"
  environment:
    name: development
    
.deployBranchStageSecrets:
  image: ${HELMER_IMAGE}
  stage: deploy
  variables:
    GCLOUD_PROJECT_ID: ${GCLOUD_PROJECT_ID_STAGE}
    GCLOUD_GKE_CLUSTER_NAME: ${GCLOUD_GKE_CLUSTER_STAGE}
    GCLOUD_GKE_ZONE: ${GCLOUD_GKE_ZONE_STAGE}
    GCLOUD_GKE_NAMESPACE: ${GCLOUD_GKE_NAMESPACE_STAGE}
    VAULTIER_RUN_CAUSE: delivery
    VAULTIER_OUTPUT_FORMAT: helm
    VAULTIER_SECRET_OUTPUT_PATH: /tmp/secrets.json
  script: *deployScriptSecrets
  allow_failure: false # important for manual jobs
  only:
    refs: ["stage"]
    variables:
      - $CI_PIPELINE_SOURCE == "push"
  environment:
    name: development
